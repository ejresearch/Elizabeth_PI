<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Bucket Manager - Multi-Project Knowledge System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        .bucket-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bucket-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        .bucket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }
        @media (max-width: 640px) {
            .bucket-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .tab-inactive {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    
    <!-- Enhanced Header with Project Context -->
    <header class="gradient-bg text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-4xl">üóÇÔ∏è</div>
                    <div>
                        <h1 class="text-3xl font-bold">Multi-Project Bucket Manager</h1>
                        <p class="text-blue-100" id="project-context">Knowledge bases across all your projects</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Project Selector -->
                    <select id="project-selector" class="glass-effect text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        <option value="current">Current Project</option>
                        <option value="all">All Projects</option>
                    </select>
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="glass-effect p-2 rounded-lg hover:bg-white/20 transition-colors">
                        <span id="theme-icon" class="text-xl">üåô</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Enhanced Tab Navigation -->
    <div class="gradient-bg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-2 pb-6">
                <button onclick="showTab('my-buckets')" id="tab-my-buckets" class="tab-active px-6 py-3 rounded-lg font-medium transition-all">
                    üìÅ My Buckets
                </button>
                <button onclick="showTab('library')" id="tab-library" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all">
                    üåê Browse Library
                </button>
                <button onclick="showTab('all-projects')" id="tab-all-projects" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all">
                    üè† All Projects
                </button>
                <button onclick="showTab('analytics')" id="tab-analytics" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all">
                    üìä Analytics
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- API Key Management -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 mb-8 shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üîë</span>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">OpenAI API Key</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Required for knowledge graph processing</p>
                    </div>
                </div>
                <div id="api-status" class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">Checking...</span>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <div class="flex-1">
                    <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key (sk-...)"
                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <button onclick="setApiKey()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    Set & Test
                </button>
            </div>
            <div id="api-key-message" class="mt-4 hidden"></div>
        </div>

        <!-- My Buckets Tab -->
        <div id="content-my-buckets" class="tab-content">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">My Project Buckets</h2>
                    <p class="text-gray-600 dark:text-gray-400">Knowledge bases in your current project</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="showCreateBucketModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                        ‚ûï New Bucket
                    </button>
                    <button onclick="refreshBuckets()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Buckets</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white mt-1" id="stat-buckets">0</p>
                        </div>
                        <div class="p-3 bg-blue-500/10 rounded-lg">
                            <span class="text-2xl">üóÇÔ∏è</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Nodes</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white mt-1" id="stat-nodes">0</p>
                        </div>
                        <div class="p-3 bg-green-500/10 rounded-lg">
                            <span class="text-2xl">üîó</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Files</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white mt-1" id="stat-files">0</p>
                        </div>
                        <div class="p-3 bg-purple-500/10 rounded-lg">
                            <span class="text-2xl">üìÑ</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Edges</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white mt-1" id="stat-edges">0</p>
                        </div>
                        <div class="p-3 bg-orange-500/10 rounded-lg">
                            <span class="text-2xl">‚ÜîÔ∏è</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buckets Grid -->
            <div id="buckets-grid" class="bucket-grid">
                <!-- Bucket cards will be populated here -->
            </div>
        </div>

        <!-- Library Tab -->
        <div id="content-library" class="tab-content hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Library Buckets</h2>
                    <p class="text-gray-600 dark:text-gray-400">Shared knowledge bases available for import</p>
                </div>
                <div class="flex space-x-3">
                    <input type="text" id="library-search" placeholder="Search library..." 
                           class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           onkeyup="searchLibrary(this.value)">
                    <button onclick="refreshLibrary()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <div id="library-grid" class="bucket-grid">
                <!-- Library buckets will be populated here -->
            </div>
        </div>

        <!-- All Projects Tab -->
        <div id="content-all-projects" class="tab-content hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">All Projects</h2>
                    <p class="text-gray-600 dark:text-gray-400">Browse and import buckets from other projects</p>
                </div>
            </div>
            
            <div id="projects-list" class="space-y-6">
                <!-- Projects will be populated here -->
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="content-analytics" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Knowledge Analytics</h2>
                <p class="text-gray-600 dark:text-gray-400">Insights across all your knowledge bases</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Analytics charts and data will go here -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Top Performing Buckets</h3>
                    <div id="top-buckets-chart" class="space-y-3">
                        <!-- Chart content -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Knowledge Growth</h3>
                    <div id="growth-chart">
                        <!-- Chart content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Bucket Card Modal -->
    <div id="bucket-modal" class="fixed inset-0 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" onclick="closeBucketModal()"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden fade-in">
                <div id="modal-content">
                    <!-- Modal content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Bucket Modal -->
    <div id="create-bucket-modal" class="fixed inset-0 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" onclick="closeCreateBucketModal()"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6 fade-in">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Create New Bucket</h3>
                <form onsubmit="createBucket(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bucket Name</label>
                            <input type="text" id="new-bucket-name" required placeholder="my_knowledge_base"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                            <textarea id="new-bucket-description" rows="3" placeholder="Describe this knowledge base..."
                                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bucket Type</label>
                            <select id="new-bucket-scope" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="local">üìÅ Project-only (Local)</option>
                                <option value="library">üåê Shareable (Library)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            Create Bucket
                        </button>
                        <button type="button" onclick="closeCreateBucketModal()" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 flex items-center space-x-3 min-w-[300px] border border-gray-200 dark:border-gray-700">
            <span id="toast-icon" class="text-2xl"></span>
            <div class="flex-1">
                <p id="toast-message" class="text-sm font-medium text-gray-900 dark:text-white"></p>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let buckets = [];
        let libraryBuckets = [];
        let allProjects = [];
        let currentTab = 'my-buckets';
        let currentProject = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            detectCurrentProject();
            checkApiKeyStatus();
            loadBuckets();
            loadLibraryBuckets();
            loadAllProjects();
            checkDarkMode();
        });

        // Project Detection
        function detectCurrentProject() {
            // This would be enhanced to detect the current Lizzy project
            currentProject = "Current Project";
            document.getElementById('project-context').textContent = `Managing buckets for: ${currentProject}`;
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = btn.className.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`tab-${tabName}`).className = document.getElementById(`tab-${tabName}`).className.replace('tab-inactive', 'tab-active');
            
            currentTab = tabName;
            
            // Load data for specific tabs
            if (tabName === 'library') {
                loadLibraryBuckets();
            } else if (tabName === 'all-projects') {
                loadAllProjects();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Enhanced Bucket Card Creation
        function createEnhancedBucketCard(bucket) {
            const card = document.createElement('div');
            card.className = 'bucket-card bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 cursor-pointer fade-in';
            card.onclick = () => openBucketModal(bucket);
            
            const bucketType = bucket.type || 'local';
            const bucketScope = bucket.scope || 'project';
            
            // Type badge styling
            const typeBadge = bucketType === 'library' ? 'üåê Library' : 
                            bucketType === 'imported' ? 'üì• Imported' : 'üìÅ Local';
            const typeBadgeColor = bucketType === 'library' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' :
                                 bucketType === 'imported' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300' :
                                 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
            
            // Status determination
            const hasFiles = (bucket.files && bucket.files.length > 0) || (bucket.file_details && bucket.file_details.length > 0);
            const statusIcon = hasFiles ? '‚úÖ' : 'üìù';
            const statusText = hasFiles ? 'Active' : 'Empty';
            const statusColor = hasFiles ? 'text-green-500' : 'text-yellow-500';
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="font-bold text-gray-900 dark:text-white text-lg truncate">${bucket.name || bucket.id}</h3>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeBadgeColor}">
                                ${typeBadge}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${bucket.description || 'No description'}</p>
                    </div>
                    <div class="flex flex-col items-end ml-4">
                        <span class="${statusColor} text-2xl">${statusIcon}</span>
                        <span class="text-xs ${statusColor} font-medium">${statusText}</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg p-4 text-center">
                        <p class="text-xs text-blue-600 dark:text-blue-400 uppercase tracking-wide font-semibold">Nodes</p>
                        <p class="text-xl font-bold text-blue-700 dark:text-blue-300">${(bucket.nodes || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg p-4 text-center">
                        <p class="text-xs text-green-600 dark:text-green-400 uppercase tracking-wide font-semibold">Edges</p>
                        <p class="text-xl font-bold text-green-700 dark:text-green-300">${(bucket.edges || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg p-4 text-center">
                        <p class="text-xs text-purple-600 dark:text-purple-400 uppercase tracking-wide font-semibold">Files</p>
                        <p class="text-xl font-bold text-purple-700 dark:text-purple-300">${bucket.files ? bucket.files.length : (bucket.file_details ? bucket.file_details.length : 0)}</p>
                    </div>
                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 rounded-lg p-4 text-center">
                        <p class="text-xs text-orange-600 dark:text-orange-400 uppercase tracking-wide font-semibold">Size</p>
                        <p class="text-xl font-bold text-orange-700 dark:text-orange-300">${bucket.size || '0 MB'}</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-4 pt-3 border-t border-gray-100 dark:border-gray-700">
                    <span>Updated: ${bucket.updated || 'Unknown'}</span>
                    ${bucket.projects && bucket.projects.length ? `<span title="Shared with projects">üì§ ${bucket.projects.length}</span>` : ''}
                </div>
                
                <div class="flex gap-2">
                    <button onclick="event.stopPropagation(); uploadTobucket('${bucket.id || bucket.name}')" 
                            class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-medium transition-all transform hover:scale-105">
                        <span class="flex items-center justify-center gap-2">
                            <span>üìö</span>
                            <span class="hidden sm:inline">Add & Process</span>
                        </span>
                    </button>
                    <button onclick="event.stopPropagation(); manageBucket('${bucket.id || bucket.name}')" 
                            class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">
                        <span>‚öôÔ∏è</span>
                    </button>
                    ${bucketType !== 'library' ? `
                    <button onclick="event.stopPropagation(); deleteBucket('${bucket.id || bucket.name}')" 
                            class="px-4 py-2 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                        <span>üóëÔ∏è</span>
                    </button>
                    ` : `
                    <button onclick="event.stopPropagation(); importFromLibrary('${bucket.id}')" 
                            class="px-4 py-2 bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-800/30 transition-all">
                        <span>üì•</span>
                    </button>
                    `}
                </div>
            `;
            
            return card;
        }

        // API Functions
        async function loadBuckets() {
            try {
                showToast('Loading project buckets...', 'info');
                const response = await fetch('/api/buckets');
                if (response.ok) {
                    buckets = await response.json();
                    renderBuckets();
                    updateStats();
                } else {
                    throw new Error('Failed to load buckets');
                }
            } catch (error) {
                console.error('Error loading buckets:', error);
                showToast('Failed to load buckets', 'error');
            }
        }

        async function loadLibraryBuckets() {
            try {
                const response = await fetch('/api/library/buckets');
                if (response.ok) {
                    libraryBuckets = await response.json();
                    renderLibraryBuckets();
                } else {
                    libraryBuckets = [];
                    renderLibraryBuckets();
                }
            } catch (error) {
                console.error('Error loading library buckets:', error);
                libraryBuckets = [];
                renderLibraryBuckets();
            }
        }

        async function loadAllProjects() {
            // This would be enhanced to load actual project data
            allProjects = [
                { name: 'Current Project', bucketCount: buckets.length, lastActive: 'Now' },
                { name: 'Screenplay Project', bucketCount: 8, lastActive: '2 days ago' },
                { name: 'Research Notes', bucketCount: 12, lastActive: '1 week ago' }
            ];
            renderAllProjects();
        }

        function renderBuckets() {
            const container = document.getElementById('buckets-grid');
            container.innerHTML = '';
            
            if (buckets.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üóÇÔ∏è</div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No buckets yet</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Create your first knowledge base to get started</p>
                        <button onclick="showCreateBucketModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            ‚ûï Create First Bucket
                        </button>
                    </div>
                `;
                return;
            }
            
            buckets.forEach(bucket => {
                const card = createEnhancedBucketCard(bucket);
                container.appendChild(card);
            });
        }

        function renderLibraryBuckets() {
            const container = document.getElementById('library-grid');
            container.innerHTML = '';
            
            if (libraryBuckets.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üåê</div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No library buckets available</h3>
                        <p class="text-gray-600 dark:text-gray-400">Shared knowledge bases will appear here</p>
                    </div>
                `;
                return;
            }
            
            libraryBuckets.forEach(bucket => {
                bucket.type = 'library';
                const card = createEnhancedBucketCard(bucket);
                container.appendChild(card);
            });
        }

        function renderAllProjects() {
            const container = document.getElementById('projects-list');
            container.innerHTML = '';
            
            allProjects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700';
                projectCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-blue-100 dark:bg-blue-900/20 rounded-lg">
                                <span class="text-2xl">üè†</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${project.name}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${project.bucketCount} buckets ‚Ä¢ Last active: ${project.lastActive}</p>
                            </div>
                        </div>
                        <button onclick="browseProjectBuckets('${project.name}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            Browse Buckets
                        </button>
                    </div>
                `;
                container.appendChild(projectCard);
            });
        }

        // Enhanced Bucket Management
        async function createBucket(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-bucket-name').value;
            const description = document.getElementById('new-bucket-description').value;
            const scope = document.getElementById('new-bucket-scope').value;
            
            try {
                showToast('Creating bucket...', 'info');
                const response = await fetch('/api/buckets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, scope })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeCreateBucketModal();
                    await loadBuckets();
                    if (scope === 'library') {
                        await loadLibraryBuckets();
                    }
                    showToast(`‚úÖ Created ${scope} bucket: ${name}`, 'success');
                } else {
                    showToast(`‚ùå Failed to create bucket: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error creating bucket:', error);
                showToast('‚ùå Error creating bucket', 'error');
            }
        }

        async function deleteBucket(bucketId) {
            if (!confirm(`Are you sure you want to delete "${bucketId}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                showToast(`Deleting ${bucketId}...`, 'info');
                const response = await fetch(`/api/buckets/${bucketId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    await loadBuckets();
                    showToast(`‚úÖ Deleted: ${bucketId}`, 'success');
                } else {
                    showToast(`‚ùå Failed to delete: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting bucket:', error);
                showToast(`‚ùå Error deleting bucket`, 'error');
            }
        }

        async function importFromLibrary(bucketId) {
            try {
                showToast(`Importing ${bucketId}...`, 'info');
                const response = await fetch(`/api/library/import/${bucketId}`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    await loadBuckets();
                    showToast(`‚úÖ Imported: ${bucketId}`, 'success');
                } else {
                    showToast(`‚ùå Failed to import: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error importing bucket:', error);
                showToast(`‚ùå Error importing bucket`, 'error');
            }
        }

        // Modal Management
        function showCreateBucketModal() {
            document.getElementById('create-bucket-modal').classList.remove('hidden');
        }

        function closeCreateBucketModal() {
            document.getElementById('create-bucket-modal').classList.add('hidden');
            document.getElementById('new-bucket-name').value = '';
            document.getElementById('new-bucket-description').value = '';
        }

        function openBucketModal(bucket) {
            const modal = document.getElementById('bucket-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">${bucket.name || bucket.id}</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-1">${bucket.description || 'No description'}</p>
                        </div>
                        <button onclick="closeBucketModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                    </div>
                </div>
                
                <div class="p-6 max-h-96 overflow-y-auto">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${(bucket.nodes || 0).toLocaleString()}</p>
                            <p class="text-sm text-blue-600 dark:text-blue-400">Nodes</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <p class="text-2xl font-bold text-green-600 dark:text-green-400">${(bucket.edges || 0).toLocaleString()}</p>
                            <p class="text-sm text-green-600 dark:text-green-400">Edges</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                            <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">${bucket.files ? bucket.files.length : 0}</p>
                            <p class="text-sm text-purple-600 dark:text-purple-400">Files</p>
                        </div>
                        <div class="text-center p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                            <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${bucket.size || '0 MB'}</p>
                            <p class="text-sm text-orange-600 dark:text-orange-400">Size</p>
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Files</h4>
                    <div class="space-y-2">
                        ${(bucket.files || bucket.file_details || []).length > 0 ? 
                            (bucket.files || bucket.file_details || []).map(file => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üìÑ</span>
                                        <span class="text-sm font-medium text-gray-900 dark:text-white">${typeof file === 'string' ? file : file.name}</span>
                                    </div>
                                    <button onclick="deleteFileFromBucket('${bucket.id || bucket.name}', '${typeof file === 'string' ? file : file.name}')" 
                                            class="text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 p-1 rounded">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            `).join('') : 
                            '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No files in this bucket</p>'
                        }
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex space-x-3">
                    <button onclick="uploadToButton('${bucket.id || bucket.name}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        üìö Add Files
                    </button>
                    <button onclick="exportBucket('${bucket.id || bucket.name}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        üì§ Export
                    </button>
                    <button onclick="closeBucketModal()" class="ml-auto px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        Close
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeBucketModal() {
            document.getElementById('bucket-modal').classList.add('hidden');
        }

        // Utility Functions
        function updateStats() {
            const totalNodes = buckets.reduce((sum, b) => sum + (b.nodes || 0), 0);
            const totalEdges = buckets.reduce((sum, b) => sum + (b.edges || 0), 0);
            const totalFiles = buckets.reduce((sum, b) => sum + ((b.files && b.files.length) || (b.file_details && b.file_details.length) || 0), 0);
            
            document.getElementById('stat-buckets').textContent = buckets.length;
            document.getElementById('stat-nodes').textContent = totalNodes.toLocaleString();
            document.getElementById('stat-edges').textContent = totalEdges.toLocaleString();
            document.getElementById('stat-files').textContent = totalFiles;
        }

        async function refreshBuckets() {
            showToast('Refreshing...', 'info');
            await loadBuckets();
            if (currentTab === 'library') {
                await loadLibraryBuckets();
            }
            showToast('‚úÖ Refreshed', 'success');
        }

        // API Key Management
        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/api/apikey/status');
                if (response.ok) {
                    const status = await response.json();
                    updateApiKeyStatus(status);
                }
            } catch (error) {
                console.error('Error checking API key:', error);
            }
        }

        function updateApiKeyStatus(status) {
            const statusElement = document.getElementById('api-status');
            const statusDot = statusElement.querySelector('.w-3');
            const statusText = statusElement.querySelector('span:last-child');
            
            if (status.openai_key_present && status.openai_key_format_valid) {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-400 mr-2';
                statusText.textContent = '‚úÖ Key Active';
                statusText.className = 'text-sm text-green-600 dark:text-green-400';
            } else {
                statusDot.className = 'w-3 h-3 rounded-full bg-red-400 mr-2';
                statusText.textContent = '‚ùå No API Key';
                statusText.className = 'text-sm text-red-600 dark:text-red-400';
            }
        }

        async function setApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            
            if (!apiKey.startsWith('sk-')) {
                showToast('‚ùå Invalid API key format', 'error');
                return;
            }
            
            try {
                showToast('Testing API key...', 'info');
                const response = await fetch('/api/apikey/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('api-key-input').value = '';
                    await checkApiKeyStatus();
                    showToast('‚úÖ API key set successfully!', 'success');
                } else {
                    showToast(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                showToast('‚ùå Failed to set API key', 'error');
            }
        }

        // Dark Mode
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark);
        }

        function checkDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            
            const icons = { 'success': '‚úÖ', 'error': '‚ùå', 'info': '‚ÑπÔ∏è', 'warning': '‚ö†Ô∏è' };
            
            icon.textContent = icons[type] || icons.info;
            msg.textContent = message;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Placeholder functions for features to be implemented
        function uploadToButton(bucketId) {
            showToast('File upload feature coming soon!', 'info');
        }

        function manageBucket(bucketId) {
            // Find and open the bucket modal
            const bucket = buckets.find(b => (b.id || b.name) === bucketId) || 
                          libraryBuckets.find(b => (b.id || b.name) === bucketId);
            if (bucket) {
                openBucketModal(bucket);
            }
        }

        function exportBucket(bucketId) {
            showToast(`Exporting ${bucketId}...`, 'info');
        }

        function searchLibrary(query) {
            // Implement library search
            showToast('Library search feature coming soon!', 'info');
        }

        function refreshLibrary() {
            loadLibraryBuckets();
        }

        function browseProjectBuckets(projectName) {
            showToast(`Browsing ${projectName} buckets...`, 'info');
        }

        function loadAnalytics() {
            // Implement analytics loading
            showToast('Analytics coming soon!', 'info');
        }

        async function deleteFileFromBucket(bucketId, fileName) {
            if (!confirm(`Delete "${fileName}"?`)) return;
            
            try {
                const response = await fetch(`/api/buckets/${bucketId}/files/${fileName}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    await loadBuckets();
                    closeBucketModal();
                    showToast(`‚úÖ Deleted: ${fileName}`, 'success');
                } else {
                    showToast(`‚ùå Failed to delete: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`‚ùå Error deleting file`, 'error');
            }
        }
    </script>

</body>
</html>