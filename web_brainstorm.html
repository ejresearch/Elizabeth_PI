<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Prompt Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f8fafc;
            --panel: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .header p {
            font-size: 18px;
            color: var(--muted);
        }

        .project-selector {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .project-dropdown {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
            margin: 0 12px;
        }

        .project-info {
            margin-top: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 14px;
            color: var(--muted);
        }

        .builder {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            gap: 24px;
            height: calc(100vh - 220px);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s;
        }

        .builder.active {
            opacity: 1;
            pointer-events: auto;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .panel-header {
            background: #f1f5f9;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 20px;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        /* Data Blocks */
        .block-category {
            margin-bottom: 24px;
        }

        .block-category h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-block {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 14px;
            color: var(--text);
            position: relative;
        }

        .data-block:hover {
            background: #f1f5f9;
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .data-block.sql {
            border-left: 4px solid var(--success);
        }

        .data-block.lightrag {
            border-left: 4px solid var(--warning);
        }
        
        .data-block.lightrag.importable {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #f59e0b10, #fbbf2420);
            border-style: dashed;
            border-width: 2px;
            border-right: 2px dashed #f59e0b;
            border-top: 2px dashed #f59e0b;
            border-bottom: 2px dashed #f59e0b;
        }

        .data-block.context {
            border-left: 4px solid var(--accent);
        }
        
        .block-type {
            font-size: 0.7em;
            color: var(--warning);
            margin-top: 4px;
            font-weight: 500;
        }
        
        .block-projects {
            font-size: 0.7em;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .block-action {
            font-size: 0.7em;
            color: #f59e0b;
            margin-top: 4px;
            font-weight: 600;
        }

        .block-label {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .block-desc {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .block-sample {
            font-size: 11px;
            color: var(--muted);
            font-family: 'SF Mono', monospace;
            background: #f8fafc;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 6px;
        }

        .block-count {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--muted);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Templates */
        .template-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .template-btn {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--panel);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .template-btn:hover {
            border-color: var(--accent);
            background: #f8fafc;
        }

        .template-btn.active {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        .template-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .template-desc {
            font-size: 12px;
            color: var(--muted);
        }

        .template-btn.active .template-desc {
            color: rgba(255,255,255,0.8);
        }

        /* Editor */
        .editor {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 20px;
            border: none;
            background: var(--panel);
            color: var(--text);
            resize: none;
            width: 100%;
            height: 100%;
        }

        .editor:focus {
            outline: none;
        }

        /* Preview */
        .preview {
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Action buttons */
        .actions {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: #f8fafc;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-secondary {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .loading {
            text-align: center;
            color: var(--muted);
            font-style: italic;
        }

        .error {
            color: var(--danger);
            background: #fee;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Landing page styles */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
            max-width: 800px;
        }

        .mode-card {
            background: var(--panel);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }

        .mode-card h3 {
            font-size: 24px;
            margin-bottom: 16px;
            color: var(--text);
        }

        .mode-card p {
            color: var(--muted);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .mode-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        /* Mode toggle styles */
        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            background: var(--bg);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--muted);
        }

        .mode-btn.active {
            background: var(--accent);
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: var(--panel);
            color: var(--text);
        }

        /* Chat interface styles */
        .chat-container {
            display: none;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            height: calc(100vh - 220px);
        }

        .chat-container.active {
            display: grid;
        }

        .chat-sidebar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .chat-main {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--panel);
        }

        .chat-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.user {
            background: var(--accent);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: var(--panel);
            border: 1px solid var(--border);
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Bucket Guidance Modal */
        .bucket-guidance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .bucket-guidance-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--panel);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
        }

        .guidance-section {
            margin-bottom: 20px;
        }

        .guidance-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .guidance-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }

        .query-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .param-group {
            display: flex;
            flex-direction: column;
        }

        .param-group label {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .param-group select,
        .param-group input {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .focus-slider {
            width: 100%;
        }

        .focus-value {
            text-align: center;
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .preset-suggestions {
            margin-bottom: 16px;
        }

        .preset-suggestions h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--muted);
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preset-btn {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Enhanced bucket blocks in editor */
        .enhanced-bucket-block {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f610, #3b82f620);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 2px;
            font-size: 12px;
            position: relative;
        }

        .bucket-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .edit-guidance-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 10px;
            opacity: 0.7;
        }

        .edit-guidance-btn:hover {
            opacity: 1;
        }

        .bucket-guidance-preview {
            font-size: 10px;
            color: var(--muted);
            font-style: italic;
            margin-top: 2px;
        }

        .bucket-params {
            font-size: 9px;
            color: var(--muted);
            margin-top: 4px;
        }

        /* Bucket Orchestration Panel */
        .orchestration-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 16px;
            overflow: hidden;
        }

        .orchestration-header {
            background: #f1f5f9;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .orchestration-content {
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .bucket-sequence {
            margin-bottom: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .sequence-header {
            background: #f8fafc;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sequence-buckets {
            padding: 12px;
        }

        .bucket-in-sequence {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .guidance-preview {
            font-size: 12px;
            color: var(--muted);
            font-style: italic;
            flex: 1;
            margin: 0 12px;
        }

        .reorder-btn {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
        }

        .reorder-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Dynamic Prompt Studio</h1>
            <p>System-agnostic prompt engineering with real project data</p>
            <div id="mode-toggle" class="mode-toggle" style="display: none;">
                <button id="builder-mode-btn" class="mode-btn active" onclick="switchMode('builder')">
                    üõ†Ô∏è Prompt Builder
                </button>
                <button id="chat-mode-btn" class="mode-btn" onclick="switchMode('chat')">
                    üí¨ AI Chat
                </button>
            </div>
        </div>

        <!-- Project Selector -->
        <div class="project-selector">
            <label for="project-select" style="font-weight: 600; margin-right: 12px;">Select Project:</label>
            <select id="project-select" class="project-dropdown" onchange="loadProject()">
                <option value="">Loading projects...</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshProjects()" style="margin-left: 12px;">üîÑ Refresh</button>
            
            <div id="project-info" class="project-info" style="display: none;">
                <div class="loading">Analyzing project schema...</div>
            </div>
        </div>

        <!-- Landing Page -->
        <div id="landing-page" class="landing-page">
            <h2>Welcome to Dynamic Prompt Studio</h2>
            <p style="font-size: 18px; color: var(--muted); margin-bottom: 20px;">Choose your workflow:</p>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="testBasicFunction()" class="btn btn-secondary" style="margin-right: 10px;">üîß Test Basic JS</button>
                <button onclick="selectMode('builder')" class="btn btn-accent" style="background: var(--accent); color: white;">üöÄ Force Builder Mode</button>
            </div>
            
            <div class="mode-selection">
                <div class="mode-card" onclick="selectMode('builder')">
                    <span class="mode-icon">üõ†Ô∏è</span>
                    <h3>Prompt Builder</h3>
                    <p>Create and manage custom prompt templates using real project data. Build sophisticated prompts with SQL tables and LightRAG knowledge buckets.</p>
                    <button class="btn btn-primary">Start Building</button>
                </div>
                
                <div class="mode-card" onclick="selectMode('chat')">
                    <span class="mode-icon">üí¨</span>
                    <h3>AI Chat & Brainstorm</h3>
                    <p>Chat with AI using your custom prompts and real project data. Generate ideas, explore scenes, and brainstorm creative solutions.</p>
                    <button class="btn btn-success">Start Chatting</button>
                </div>
            </div>
        </div>

        <!-- Main Builder Interface -->
        <div id="builder" class="builder" style="display: none;">
            <!-- Left: Dynamic Data Blocks -->
            <div class="panel">
                <div class="panel-header">
                    <span>üìä Data Blocks</span>
                    <span id="block-count" style="font-size: 12px; color: var(--muted);">0 blocks</span>
                </div>
                <div class="panel-content">
                    
                    <div class="block-category">
                        <h3>üìã Templates</h3>
                        <div class="template-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 4px;">
                            <button class="btn btn-secondary" onclick="newTemplate()" style="font-size: 11px; padding: 6px 10px;">+ New</button>
                            <button class="btn btn-secondary" onclick="duplicateTemplate()" style="font-size: 11px; padding: 6px 10px;">üìã Duplicate</button>
                            <button class="btn btn-secondary" onclick="convertTemplateToEnhanced()" style="font-size: 11px; padding: 6px 10px;">üîß Enhance</button>
                            <button class="btn btn-secondary" onclick="showTemplateTools()" style="font-size: 11px; padding: 6px 10px;">üõ†Ô∏è Tools</button>
                            <button class="btn btn-secondary" onclick="testEnhancedFeature()" style="font-size: 11px; padding: 6px 10px; background: var(--accent); color: white;">Test ‚ú®</button>
                        </div>
                        <div id="template-list" class="template-grid">
                            <div class="loading">Loading templates...</div>
                        </div>
                    </div>

                    <div id="sql-blocks" class="block-category" style="display: none;">
                        <h3><span class="spinner" style="width: 12px; height: 12px;"></span>üóÑÔ∏è Project Data</h3>
                        <div class="loading">Discovering database schema...</div>
                    </div>

                    <div id="lightrag-blocks" class="block-category" style="display: none;">
                        <h3>üìö LightRAG Buckets</h3>
                        <div class="loading">Discovering knowledge buckets...</div>
                    </div>

                    <div id="context-blocks" class="block-category" style="display: none;">
                        <h3>üéØ Context Variables</h3>
                        <div class="loading">Loading context options...</div>
                    </div>
                    
                    <!-- Bucket Orchestration Panel -->
                    <div id="bucket-orchestration" class="orchestration-panel" style="display: none;">
                        <div class="orchestration-header">
                            <span>üéº Bucket Orchestration</span>
                            <button class="btn btn-secondary" onclick="toggleOrchestration()" style="font-size: 12px; padding: 4px 8px;">Show/Hide</button>
                        </div>
                        <div id="orchestration-content" class="orchestration-content" style="display: none;">
                            <div id="bucket-sequences">
                                <!-- Bucket sequences will be populated here -->
                            </div>
                            
                            <div style="margin-top: 16px; text-align: center;">
                                <button class="btn btn-primary" onclick="addBucketSequence()" style="font-size: 12px; padding: 6px 12px;">+ Add Sequence</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Editor -->
            <div class="panel">
                <div class="panel-header">‚úèÔ∏è Prompt Editor</div>
                <textarea id="prompt-editor" class="editor" placeholder="Select a template (left) or write your own prompt...

Click data blocks to insert variables from your project's real data.

Variables will be replaced with actual content when you brainstorm."></textarea>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="clearEditor()">Clear</button>
                    <button class="btn btn-secondary" onclick="previewPrompt()">Preview</button>
                    <button class="btn btn-primary" onclick="saveCurrentPrompt()">üíæ Save</button>
                    <button class="btn btn-success" onclick="startBrainstorm()">‚Üí Brainstorm</button>
                </div>
            </div>

            <!-- Right: Preview & Info -->
            <div class="panel">
                <div class="panel-header">üëÅÔ∏è Live Preview</div>
                <div class="panel-content">
                    <div id="preview-area" class="preview">
Select a project and click "Preview" to see your prompt compiled with real data...
                    </div>
                    
                    <div id="project-stats" style="margin-top: 24px; display: none;">
                        <h3 style="font-size: 16px; margin-bottom: 12px;">üìä Project Stats</h3>
                        <div id="stats-content" style="background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 14px;"></div>
                    </div>

                    <h3 style="margin: 24px 0 12px; font-size: 16px;">üí° Enhanced Features</h3>
                    <ul style="font-size: 14px; color: var(--muted); line-height: 1.6;">
                        <li><strong>Smart Bucket Insertion:</strong> Click LightRAG buckets to add guidance</li>
                        <li><strong>Enhanced Variables:</strong> {lightrag.bucket|guidance:"..."|mode:"mix"}</li>
                        <li><strong>Orchestration:</strong> Manage multiple buckets with specific roles</li>
                        <li><strong>Template Configs:</strong> Save bucket setups with templates</li>
                        <li><strong>Live Preview:</strong> See actual data and guidance compilation</li>
                    </ul>
                    
                    <div id="bucket-config-summary" style="margin-top: 16px; display: none;">
                        <h4 style="font-size: 14px; margin-bottom: 8px; color: var(--accent);">Active Bucket Configurations:</h4>
                        <div id="config-summary-content" style="background: #f8fafc; padding: 8px; border-radius: 4px; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="chat-container" class="chat-container">
            <!-- Left: Chat Controls -->
            <div class="chat-sidebar">
                <div class="panel-header">
                    <span>üí¨ AI Brainstorm Chat</span>
                </div>
                <div class="panel-content">
                    <div class="block-category">
                        <h3>üìã Select Prompt Template</h3>
                        <div style="margin-bottom: 12px;">
                            <button onclick="toggleTemplateQuick()" class="btn btn-secondary" style="width: 100%; font-size: 14px; padding: 8px;">
                                ‚ö° Quick Toggle Templates
                            </button>
                        </div>
                        <div id="chat-template-list">
                            <div class="loading">Loading templates...</div>
                        </div>
                    </div>
                    
                    <div class="block-category" style="margin-top: 24px;">
                        <h3>‚öôÔ∏è Chat Settings</h3>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 14px;">API Key:</label>
                            <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px;">
                            <button onclick="toggleApiKeyVisibility()" style="margin-top: 4px; font-size: 12px; background: none; border: none; color: var(--accent); cursor: pointer;">üëÅÔ∏è Show/Hide</button>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 14px;">Temperature:</label>
                            <input type="range" id="temperature-slider" min="0" max="1" step="0.1" value="0.7" style="width: 100%;">
                            <span id="temperature-value" style="font-size: 12px; color: var(--muted);">0.7</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 14px;">Model:</label>
                            <select id="model-select" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="gpt-4o">GPT-4o (Latest)</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="block-category" style="margin-top: 24px;">
                        <h3>üíæ Chat History</h3>
                        <div id="chat-history-list">
                            <div style="font-size: 14px; color: var(--muted); font-style: italic;">No conversations yet</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: Chat Interface -->
            <div class="chat-main">
                <div class="panel-header">
                    <span id="current-template-name">Select a template to start chatting</span>
                    <button class="btn btn-secondary" onclick="clearChat()" style="font-size: 12px; padding: 6px 12px;">Clear Chat</button>
                </div>
                
                <div id="chat-messages" class="chat-messages">
                    <div style="text-align: center; color: var(--muted); margin-top: 40px;">
                        <h3>ü§ñ AI Brainstorm Assistant</h3>
                        <p>Select a prompt template from the left to start brainstorming!</p>
                        <p style="font-size: 14px; margin-top: 16px;">Your prompts will be automatically compiled with real project data before being sent to the AI.</p>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <textarea id="chat-input" class="chat-input" placeholder="Type your message here... (Select a template first)" disabled></textarea>
                    <div class="chat-controls">
                        <div>
                            <label style="font-size: 14px;">
                                <input type="checkbox" id="use-template-checkbox" checked> Use selected template as system prompt
                            </label>
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="attachData()" disabled id="attach-btn">üìé Attach Data</button>
                            <button class="btn btn-primary" onclick="sendMessage()" disabled id="send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bucket Guidance Modal -->
    <div id="bucket-guidance-modal" class="bucket-guidance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-bucket-title">ü™£ Configure Bucket</h3>
                <button class="close-modal" onclick="closeBucketModal()">&times;</button>
            </div>
            
            <div class="preset-suggestions">
                <h4>üí° Quick Presets:</h4>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="applyPreset('dialogue')">Find dialogue patterns</button>
                    <button class="preset-btn" onclick="applyPreset('structure')">Extract story structure</button>
                    <button class="preset-btn" onclick="applyPreset('character')">Analyze character archetypes</button>
                    <button class="preset-btn" onclick="applyPreset('tone')">Study tone and style</button>
                    <button class="preset-btn" onclick="applyPreset('technique')">Learn writing techniques</button>
                </div>
            </div>
            
            <div class="guidance-section">
                <label for="bucket-guidance-input">How should this bucket be used as context?</label>
                <textarea id="bucket-guidance-input" class="guidance-textarea" 
                         placeholder="e.g., Find dialogue patterns and comedic timing examples"></textarea>
            </div>
            
            <div class="query-params">
                <div class="param-group">
                    <label for="query-mode-select">Query Mode:</label>
                    <select id="query-mode-select">
                        <option value="mix">Mix (default)</option>
                        <option value="local">Local only</option>
                        <option value="global">Global only</option>
                        <option value="hybrid">Hybrid</option>
                        <option value="naive">Naive</option>
                    </select>
                </div>
                
                <div class="param-group">
                    <label for="focus-slider">Focus Level:</label>
                    <input type="range" id="focus-slider" class="focus-slider" 
                           min="1" max="10" value="5" oninput="updateFocusValue()">
                    <div id="focus-value" class="focus-value">5/10</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="insertBasicBucket()">Insert Basic</button>
                <button class="btn btn-primary" onclick="insertGuidedBucket()">Insert with Guidance</button>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let currentSchema = null;
        let currentTemplateId = null;
        let currentPrompts = [];
        let isEditingTemplate = false;
        let currentMode = 'landing';
        let chatHistory = [];
        let currentChatTemplate = null;
        let sqlUpdateInterval = null;
        let currentBucketBlock = null;
        let bucketConfigurations = {}; // Store bucket configurations for templates

        // Toggle API key visibility
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('api-key-input');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
            } else {
                apiKeyInput.type = 'password';
            }
        }

        // Quick toggle templates
        function toggleTemplateQuick() {
            const templates = document.querySelectorAll('#chat-template-list .data-block');
            if (templates.length === 0) return;
            
            // Find current active template
            let currentIndex = -1;
            templates.forEach((template, index) => {
                if (template.classList.contains('active')) {
                    currentIndex = index;
                }
            });
            
            // Move to next template
            const nextIndex = (currentIndex + 1) % templates.length;
            templates[nextIndex].click();
        }

        // SQL Auto-update functions
        function startSqlAutoUpdate() {
            if (sqlUpdateInterval) {
                clearInterval(sqlUpdateInterval);
            }
            
            // Update every 10 seconds
            sqlUpdateInterval = setInterval(() => {
                updateSqlData();
            }, 10000);
        }

        function stopSqlAutoUpdate() {
            if (sqlUpdateInterval) {
                clearInterval(sqlUpdateInterval);
                sqlUpdateInterval = null;
            }
        }

        function toggleSqlAutoUpdate() {
            const btn = document.getElementById('sql-auto-update-btn');
            if (sqlUpdateInterval) {
                stopSqlAutoUpdate();
                btn.textContent = 'üîÑ Auto-update: OFF';
                btn.style.background = '#fee';
            } else {
                startSqlAutoUpdate();
                btn.textContent = 'üîÑ Auto-update: ON';
                btn.style.background = '#efe';
                // Trigger immediate update
                updateSqlData();
            }
        }

        async function updateSqlData() {
            if (!currentProject) return;
            
            const indicator = document.getElementById('sql-update-indicator');
            if (indicator) indicator.style.display = 'inline-block';
            
            try {
                const response = await fetch(`/api/project/${currentProject}/schema`);
                const schema = await response.json();
                
                if (schema.error) {
                    throw new Error(schema.error);
                }
                
                // Update only SQL blocks
                const sqlContainer = document.getElementById('sql-blocks');
                if (sqlContainer) {
                    // Keep the header
                    const header = sqlContainer.querySelector('h3');
                    sqlContainer.innerHTML = '';
                    if (header) sqlContainer.appendChild(header);
                    
                    // Re-add updated SQL blocks
                    schema.data_blocks.sql.forEach(block => {
                        const blockElement = createDataBlock(block, 'sql');
                        sqlContainer.appendChild(blockElement);
                    });
                }
                
                // Update schema for preview
                currentSchema = schema;
                
                // Flash indicator to show update completed
                if (indicator) {
                    indicator.style.display = 'none';
                    setTimeout(() => {
                        const btn = document.getElementById('sql-auto-update-btn');
                        if (btn) {
                            btn.style.transition = 'background 0.3s';
                            btn.style.background = '#bfb';
                            setTimeout(() => {
                                btn.style.background = '#efe';
                            }, 300);
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error updating SQL data:', error);
                if (indicator) indicator.style.display = 'none';
            }
        }

        // Mode switching functions
        function selectMode(mode) {
            try {
                console.log('Selecting mode:', mode);
                currentMode = mode;
                
                // Hide landing page
                const landingPage = document.getElementById('landing-page');
                if (landingPage) {
                    landingPage.style.display = 'none';
                }
                
                // Show mode toggle
                const modeToggle = document.getElementById('mode-toggle');
                if (modeToggle) {
                    modeToggle.style.display = 'flex';
                }
                
                if (mode === 'builder') {
                    const builder = document.getElementById('builder');
                    if (builder) {
                        builder.style.display = 'grid';
                    }
                    
                    const chatContainer = document.getElementById('chat-container');
                    if (chatContainer) {
                        chatContainer.classList.remove('active');
                    }
                    
                    const builderBtn = document.getElementById('builder-mode-btn');
                    const chatBtn = document.getElementById('chat-mode-btn');
                    if (builderBtn) builderBtn.classList.add('active');
                    if (chatBtn) chatBtn.classList.remove('active');
                    
                    // Ensure builder is activated if project is selected
                    if (currentProject && builder) {
                        builder.classList.add('active');
                    }
                    
                    console.log('Builder mode activated');
                } else if (mode === 'chat') {
                    const builder = document.getElementById('builder');
                    const chatContainer = document.getElementById('chat-container');
                    const builderBtn = document.getElementById('builder-mode-btn');
                    const chatBtn = document.getElementById('chat-mode-btn');
                    
                    if (builder) {
                        builder.style.display = 'none';
                        builder.classList.remove('active');
                    }
                    if (chatContainer) chatContainer.classList.add('active');
                    if (builderBtn) builderBtn.classList.remove('active');
                    if (chatBtn) chatBtn.classList.add('active');
                    
                    console.log('Chat mode activated');
                }
            } catch (error) {
                console.error('Error in selectMode:', error);
                alert('Error switching modes. Check browser console for details.');
            }
        }
        
        function switchMode(mode) {
            selectMode(mode);
        }
        
        // Chat functionality
        async function loadChatTemplates() {
            if (!currentProject) return;
            
            const container = document.getElementById('chat-template-list');
            container.innerHTML = '<div class="loading">Loading templates...</div>';
            
            try {
                const response = await fetch(`/api/project/${currentProject}/prompts`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayChatTemplates(data.prompts || []);
                
            } catch (error) {
                console.error('Error loading chat templates:', error);
                container.innerHTML = `<div class="error">Error loading templates: ${error.message}</div>`;
            }
        }
        
        function displayChatTemplates(prompts) {
            const container = document.getElementById('chat-template-list');
            container.innerHTML = '';
            
            prompts.forEach(prompt => {
                const element = createChatTemplateElement(prompt);
                container.appendChild(element);
            });
        }
        
        function createChatTemplateElement(prompt) {
            const div = document.createElement('div');
            div.className = 'data-block';
            div.onclick = () => selectChatTemplate(prompt);
            
            div.innerHTML = `
                <div class="block-label">${prompt.name}</div>
                <div class="block-desc">${prompt.description || 'No description'}</div>
                <div class="block-sample" style="font-size: 10px;">Click to use for chat</div>
            `;
            
            return div;
        }
        
        async function selectChatTemplate(prompt) {
            currentChatTemplate = prompt;
            
            // Update UI
            document.getElementById('current-template-name').textContent = `Template: ${prompt.name}`;
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-input').placeholder = `Ask about your project using the "${prompt.name}" template...`;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('attach-btn').disabled = false;
            
            // Update active state
            document.querySelectorAll('#chat-template-list .data-block').forEach(el => el.classList.remove('active'));
            event.target.closest('.data-block').classList.add('active');
            
            // Add system message about template
            addSystemMessage(`Using template: "${prompt.name}". Your messages will be enhanced with real project data.`);
        }
        
        function addSystemMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message system';
            messageEl.style.cssText = 'background: #f0f9ff; border: 1px solid #0ea5e9; color: #0c4a6e; font-size: 14px; margin: 8px auto; max-width: 90%;';
            messageEl.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            
            // Remove welcome message if present
            const welcomeMsg = messagesContainer.querySelector('div[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user';
            messageEl.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function addAssistantMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant';
            messageEl.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const userMessage = input.value.trim();
            const apiKey = document.getElementById('api-key-input').value.trim();
            
            if (!userMessage || !currentChatTemplate) return;
            
            if (!apiKey) {
                alert('Please enter your OpenAI API key in the chat settings.');
                return;
            }
            
            // Add user message to chat
            addUserMessage(userMessage);
            
            // Clear input
            input.value = '';
            
            // Show loading
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message assistant';
            loadingEl.innerHTML = '<div class="loading"><span class="spinner"></span>Thinking...</div>';
            document.getElementById('chat-messages').appendChild(loadingEl);
            
            try {
                // Prepare the chat request
                const useTemplate = document.getElementById('use-template-checkbox').checked;
                const temperature = parseFloat(document.getElementById('temperature-slider').value);
                const model = document.getElementById('model-select').value;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project_name: currentProject,
                        template_id: useTemplate ? currentChatTemplate.id : null,
                        user_message: userMessage,
                        temperature: temperature,
                        model: model,
                        api_key: apiKey,
                        chat_history: chatHistory.slice(-10) // Last 10 messages for context
                    })
                });
                
                const data = await response.json();
                
                // Remove loading message
                loadingEl.remove();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Add assistant response
                addAssistantMessage(data.response);
                
                // Update chat history
                chatHistory.push({
                    role: 'user',
                    content: userMessage,
                    timestamp: new Date().toISOString()
                });
                chatHistory.push({
                    role: 'assistant', 
                    content: data.response,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                loadingEl.remove();
                addAssistantMessage(`Error: ${error.message}`);
            }
        }
        
        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div style="text-align: center; color: var(--muted); margin-top: 40px;">
                    <h3>ü§ñ AI Brainstorm Assistant</h3>
                    <p>Chat cleared. Continue brainstorming!</p>
                </div>
            `;
            chatHistory = [];
        }
        
        function attachData() {
            // Show modal or panel to select specific data to attach
            alert('Data attachment feature coming soon! For now, your template already includes relevant project data.');
        }

        // Templates are now loaded dynamically from the database

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                const select = document.getElementById('project-select');
                select.innerHTML = '<option value="">Select a project...</option>';
                
                data.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('project-select').innerHTML = '<option value="">Error loading projects</option>';
            }
        }

        async function loadProject() {
            try {
                const select = document.getElementById('project-select');
                const projectName = select.value;
                
                console.log('Loading project:', projectName);
                
                if (!projectName) {
                    const builder = document.getElementById('builder');
                    if (builder) builder.classList.remove('active');
                    return;
                }
                
                currentProject = projectName;
                const projectInfo = document.getElementById('project-info');
                if (projectInfo) {
                    projectInfo.style.display = 'block';
                    projectInfo.innerHTML = '<div class="loading"><span class="spinner"></span>Analyzing project schema...</div>';
                }
                
                const response = await fetch(`/api/project/${projectName}/schema`);
                const schema = await response.json();
                
                console.log('Received schema:', schema);
                
                if (schema.error) {
                    throw new Error(schema.error);
                }
                
                currentSchema = schema;
                displayProjectInfo(schema);
                populateDataBlocks(schema);
                loadProjectTemplates();
                
                // Show landing page if no mode selected, otherwise activate current mode
                if (currentMode === 'landing') {
                    const landingPage = document.getElementById('landing-page');
                    if (landingPage) landingPage.style.display = 'flex';
                } else if (currentMode === 'builder') {
                    const builder = document.getElementById('builder');
                    if (builder) builder.classList.add('active');
                } else if (currentMode === 'chat') {
                    loadChatTemplates();
                }
                
                console.log('Project loaded successfully');
                
            } catch (error) {
                console.error('Error loading project:', error);
                const projectInfo = document.getElementById('project-info');
                if (projectInfo) {
                    projectInfo.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                }
            }
        }

        function displayProjectInfo(schema) {
            const tableCount = Object.keys(schema.tables).length;
            const totalRows = Object.values(schema.tables).reduce((sum, table) => sum + table.row_count, 0);
            const blockCount = Object.values(schema.data_blocks).reduce((sum, blocks) => sum + blocks.length, 0);
            
            document.getElementById('project-info').innerHTML = `
                <strong>Project:</strong> ${schema.project_name} | 
                <strong>Tables:</strong> ${tableCount} | 
                <strong>Rows:</strong> ${totalRows} | 
                <strong>Data Blocks:</strong> ${blockCount}
            `;
            
            document.getElementById('block-count').textContent = `${blockCount} blocks`;
            
            // Update project stats panel
            document.getElementById('project-stats').style.display = 'block';
            document.getElementById('stats-content').innerHTML = `
                <strong>Database:</strong> ${schema.project_name}.sqlite<br>
                <strong>Tables:</strong> ${Object.keys(schema.tables).join(', ')}<br>
                <strong>Total Records:</strong> ${totalRows}<br>
                <strong>Available Blocks:</strong> ${blockCount}
            `;
        }

        function populateDataBlocks(schema) {
            // Populate SQL blocks
            const sqlContainer = document.getElementById('sql-blocks');
            sqlContainer.style.display = 'block';
            sqlContainer.innerHTML = '<h3><span id="sql-update-indicator" class="spinner" style="width: 12px; height: 12px; display: none;"></span> üóÑÔ∏è Project Data <button onclick="toggleSqlAutoUpdate()" id="sql-auto-update-btn" class="btn btn-secondary" style="font-size: 10px; padding: 4px 8px; margin-left: 8px;">üîÑ Auto-update: ON</button></h3>';
            
            schema.data_blocks.sql.forEach(block => {
                const blockElement = createDataBlock(block, 'sql');
                sqlContainer.appendChild(blockElement);
            });
            
            // Populate LightRAG blocks
            const lightragContainer = document.getElementById('lightrag-blocks');
            lightragContainer.style.display = 'block';
            lightragContainer.innerHTML = '<h3>üìö LightRAG Buckets</h3>';
            
            schema.data_blocks.lightrag.forEach(block => {
                const blockElement = createDataBlock(block, 'lightrag');
                lightragContainer.appendChild(blockElement);
            });
            
            // Populate Context blocks
            const contextContainer = document.getElementById('context-blocks');
            contextContainer.style.display = 'block';
            contextContainer.innerHTML = '<h3>üéØ Context Variables</h3>';
            
            schema.data_blocks.context.forEach(block => {
                const blockElement = createDataBlock(block, 'context');
                contextContainer.appendChild(blockElement);
            });
            
            // Show orchestration panel if we have LightRAG blocks
            const orchestrationPanel = document.getElementById('bucket-orchestration');
            if (schema.data_blocks.lightrag.length > 0) {
                orchestrationPanel.style.display = 'block';
            }
            
            // Start SQL auto-update
            startSqlAutoUpdate();
        }

        function createDataBlock(block, type) {
            const button = document.createElement('button');
            button.className = `data-block ${type}`;
            
            // Handle different bucket types
            if (block.importable) {
                // For importable buckets, show choice between import+use or just import
                button.onclick = () => showImportChoiceModal(block);
                button.classList.add('importable');
            } else {
                // Enhanced insertion for LightRAG buckets
                if (type === 'lightrag') {
                    button.onclick = () => showBucketGuidanceModal(block);
                } else {
                    button.onclick = () => insertBlock(block.key);
                }
            }
            
            let content = `
                <div class="block-label">${block.label}</div>
                <div class="block-desc">${block.description}</div>
            `;
            
            // Add type indicator for buckets
            if (type === 'lightrag' && block.type) {
                const typeIndicator = block.type === 'library' ? 'üåê' : 
                                    block.type === 'local' ? 'üìÅ' : 
                                    block.type === 'available' ? 'üì•' : 'üìÇ';
                content += `<div class="block-type">${typeIndicator} ${block.type}</div>`;
            }
            
            if (block.sample) {
                content += `<div class="block-sample">${block.sample}</div>`;
            }
            
            if (block.doc_count && block.doc_count > 0) {
                content += `<div class="block-count">${block.doc_count} docs</div>`;
            }
            
            if (block.projects && block.projects.length > 0) {
                const projectList = block.projects.join(', ');
                content += `<div class="block-projects">Shared with: ${projectList}</div>`;
            }
            
            if (block.importable) {
                content += `<div class="block-action">Click to import & use | <button onclick="event.stopPropagation(); testGuidanceModal('${block.key}', '${block.label}')" style="background:none;border:none;color:var(--accent);text-decoration:underline;cursor:pointer;font-size:inherit;">Test Guidance</button></div>`;
            }
            
            button.innerHTML = content;
            return button;
        }

        // Enhanced bucket guidance system
        function showBucketGuidanceModal(block) {
            currentBucketBlock = block;
            
            // Update modal title
            document.getElementById('modal-bucket-title').innerHTML = `ü™£ Configure: ${block.label}`;
            
            // Clear previous inputs
            document.getElementById('bucket-guidance-input').value = '';
            document.getElementById('query-mode-select').value = 'mix';
            document.getElementById('focus-slider').value = '5';
            updateFocusValue();
            
            // Show modal
            document.getElementById('bucket-guidance-modal').classList.add('active');
        }
        
        function closeBucketModal() {
            document.getElementById('bucket-guidance-modal').classList.remove('active');
            currentBucketBlock = null;
        }
        
        function showImportChoiceModal(block) {
            // For importable buckets, offer choice: import+configure or just import
            const choice = confirm(
                `Bucket "${block.label}" needs to be imported first.\n\n` +
                `Click OK to import and configure with guidance\n` +
                `Click Cancel to just import normally`
            );
            
            if (choice) {
                // Import then show guidance modal
                importAndUseBlock(block).then(() => {
                    // Create a non-importable version for guidance
                    const guidanceBlock = {
                        ...block,
                        importable: false,
                        key: block.key.replace('.available', '')
                    };
                    showBucketGuidanceModal(guidanceBlock);
                });
            } else {
                // Just import normally
                importAndUseBlock(block);
            }
        }
        
        function updateFocusValue() {
            const slider = document.getElementById('focus-slider');
            document.getElementById('focus-value').textContent = `${slider.value}/10`;
        }
        
        function applyPreset(presetType) {
            const presets = {
                'dialogue': 'Find dialogue patterns and comedic timing examples',
                'structure': 'Extract story structure and plot mechanisms',
                'character': 'Analyze character archetypes and development patterns',
                'tone': 'Study tone, style, and mood techniques',
                'technique': 'Learn specific writing techniques and craft principles'
            };
            
            document.getElementById('bucket-guidance-input').value = presets[presetType] || '';
        }
        
        function insertBasicBucket() {
            if (!currentBucketBlock) return;
            
            insertBlock(currentBucketBlock.key);
            closeBucketModal();
        }
        
        function insertGuidedBucket() {
            if (!currentBucketBlock) return;
            
            const guidance = document.getElementById('bucket-guidance-input').value.trim();
            const mode = document.getElementById('query-mode-select').value;
            const focus = document.getElementById('focus-slider').value;
            
            if (!guidance) {
                alert('Please provide guidance for how this bucket should be used.');
                return;
            }
            
            // Create enhanced variable
            const bucketKey = currentBucketBlock.key;
            const enhancedVariable = `{${bucketKey}|guidance:"${guidance}"|mode:"${mode}"|focus:${focus}}`;
            
            // Store configuration
            bucketConfigurations[bucketKey] = {
                guidance: guidance,
                mode: mode,
                focus: parseInt(focus),
                label: currentBucketBlock.label
            };
            
            // Insert into editor
            const editor = document.getElementById('prompt-editor');
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            
            editor.value = textBefore + enhancedVariable + textAfter;
            editor.focus();
            editor.setSelectionRange(cursorPos + enhancedVariable.length, cursorPos + enhancedVariable.length);
            
            closeBucketModal();
            
            // Show success message
            showStatus(`Bucket "${currentBucketBlock.label}" configured with guidance`, 'success');
            
            // Update orchestration panel if visible
            updateOrchestrationPanel();
            
            // Call enhancement callback if it exists (for template conversion)
            if (window.enhanceCallback) {
                const callback = window.enhanceCallback;
                window.enhanceCallback = null;
                callback();
            }
        }
        
        // Bucket Orchestration Functions
        function toggleOrchestration() {
            const content = document.getElementById('orchestration-content');
            const panel = document.getElementById('bucket-orchestration');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                panel.style.display = 'block';
                updateOrchestrationPanel();
            } else {
                content.style.display = 'none';
            }
        }
        
        function updateOrchestrationPanel() {
            const container = document.getElementById('bucket-sequences');
            container.innerHTML = '';
            
            // Group configured buckets by sequence (for now, just show all)
            const configuredBuckets = Object.entries(bucketConfigurations);
            
            if (configuredBuckets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted); font-style: italic;">No configured buckets yet. Add some guided buckets to see orchestration options.</p>';
                return;
            }
            
            // Create a default sequence with all configured buckets
            const sequenceDiv = document.createElement('div');
            sequenceDiv.className = 'bucket-sequence';
            sequenceDiv.innerHTML = `
                <div class="sequence-header">
                    <span>üìã Configured Buckets</span>
                    <button class="btn btn-secondary" onclick="clearAllConfigurations()" style="font-size: 10px; padding: 4px 8px;">üóëÔ∏è Clear All</button>
                </div>
                <div class="sequence-buckets">
                    ${configuredBuckets.map(([key, config]) => `
                        <div class="bucket-in-sequence">
                            <span>ü™£ ${config.label}</span>
                            <span class="guidance-preview">${config.guidance.substring(0, 50)}${config.guidance.length > 50 ? '...' : ''}</span>
                            <button class="reorder-btn" onclick="removeBucketConfig('${key}')">üóëÔ∏è</button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.appendChild(sequenceDiv);
            
            // Update bucket configuration summary
            updateBucketConfigSummary();
        }
        
        function updateBucketConfigSummary() {
            const summary = document.getElementById('bucket-config-summary');
            const content = document.getElementById('config-summary-content');
            
            if (Object.keys(bucketConfigurations).length === 0) {
                summary.style.display = 'none';
                return;
            }
            
            summary.style.display = 'block';
            content.innerHTML = Object.entries(bucketConfigurations)
                .map(([key, config]) => `
                    <div style="margin-bottom: 6px;">
                        <strong>${config.label}:</strong> ${config.guidance}<br>
                        <span style="color: var(--muted); font-size: 10px;">Mode: ${config.mode} | Focus: ${config.focus}/10</span>
                    </div>
                `).join('');
        }
        
        function addBucketSequence() {
            // For now, just show the configured buckets
            // This could be expanded to support multiple sequences
            alert('Bucket sequencing will be enhanced in the next version. Currently showing all configured buckets.');
        }
        
        function clearAllConfigurations() {
            if (confirm('Clear all bucket configurations?')) {
                bucketConfigurations = {};
                updateOrchestrationPanel();
                showStatus('All bucket configurations cleared', 'info');
            }
        }
        
        function removeBucketConfig(bucketKey) {
            if (confirm(`Remove configuration for ${bucketConfigurations[bucketKey]?.label}?`)) {
                delete bucketConfigurations[bucketKey];
                updateOrchestrationPanel();
                showStatus('Bucket configuration removed', 'info');
            }
        }
        
        function testGuidanceModal(key, label) {
            // Test function to show the guidance modal with a mock block
            const testBlock = {
                key: key,
                label: label,
                description: 'Test bucket for guidance configuration'
            };
            showBucketGuidanceModal(testBlock);
        }
        
        function extractBucketConfigsFromTemplate(template) {
            // Extract bucket configurations from enhanced variables in template
            const configs = {};
            
            try {
                // Look for enhanced variables in a simpler way
                if (template.includes('|guidance:')) {
                    console.log('Found enhanced variables in template');
                    // For now, return empty - we'll add this back when core features work
                }
            } catch (error) {
                console.error('Error extracting bucket configs:', error);
            }
            
            return configs;
        }
        
        function convertTemplateToEnhanced() {
            // Convert basic lightrag variables to enhanced ones
            const editor = document.getElementById('prompt-editor');
            let template = editor.value;
            
            // Find basic {lightrag.bucket} variables  
            const basicPattern = /\{lightrag\.([^}]+?)\}/g;
            const basicMatches = [];
            let match;
            
            while ((match = basicPattern.exec(template)) !== null) {
                const bucket = match[1];
                if (!bucketConfigurations[`lightrag.${bucket}`]) {
                    basicMatches.push(bucket);
                }
            }
            
            if (basicMatches.length === 0) {
                showStatus('No basic LightRAG variables found to enhance', 'info');
                return;
            }
            
            // Show enhancement modal for each basic variable
            enhanceBasicVariables(basicMatches, 0, template);
        }
        
        function enhanceBasicVariables(buckets, index, template) {
            if (index >= buckets.length) {
                showStatus(`Enhanced ${buckets.length} variables!`, 'success');
                return;
            }
            
            const bucket = buckets[index];
            const block = {
                key: `lightrag.${bucket}`,
                label: bucket.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                description: `Configure guidance for ${bucket} bucket`
            };
            
            // Set callback to continue with next bucket
            window.enhanceCallback = () => {
                // Replace the basic variable with enhanced one
                const editor = document.getElementById('prompt-editor');
                const config = bucketConfigurations[`lightrag.${bucket}`];
                if (config) {
                    const basicVar = `{lightrag.${bucket}}`;
                    const enhancedVar = `{lightrag.${bucket}|guidance:"${config.guidance}"|mode:"${config.mode}"|focus:${config.focus}}`;
                    editor.value = editor.value.replace(new RegExp(basicVar.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), enhancedVar);
                }
                
                // Continue with next bucket
                enhanceBasicVariables(buckets, index + 1, template);
            };
            
            showBucketGuidanceModal(block);
        }
        
        function showTemplateTools() {
            const tools = `
                Template Tools:
                
                1. Export Current Template
                2. Import Template from JSON
                3. Share Template (Copy Link)
                4. Convert Legacy Template
                5. Template Analytics
                
                Choose option (1-5):
            `;
            
            const choice = prompt(tools);
            
            switch(choice) {
                case '1':
                    exportCurrentTemplate();
                    break;
                case '2':
                    importTemplate();
                    break;
                case '3':
                    shareTemplate();
                    break;
                case '4':
                    convertTemplateToEnhanced();
                    break;
                case '5':
                    showTemplateAnalytics();
                    break;
                default:
                    if (choice) showStatus('Invalid option', 'error');
            }
        }
        
        function exportCurrentTemplate() {
            if (!currentTemplateId) {
                showStatus('Please select a template first', 'error');
                return;
            }
            
            const currentPrompt = currentPrompts.find(p => p.id === currentTemplateId);
            if (!currentPrompt) return;
            
            const exportData = {
                name: currentPrompt.name,
                description: currentPrompt.description,
                template: currentPrompt.template,
                bucket_configurations: bucketConfigurations,
                orchestration: {},
                exported_at: new Date().toISOString(),
                exported_from: currentProject
            };
            
            // Create download
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentPrompt.name.replace(/[^a-zA-Z0-9]/g, '_')}_template.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus(`Template "${currentPrompt.name}" exported`, 'success');
        }
        
        function importTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const templateData = JSON.parse(text);
                    
                    // Validate template data
                    if (!templateData.name || !templateData.template) {
                        throw new Error('Invalid template file');
                    }
                    
                    // Load into editor
                    document.getElementById('prompt-editor').value = templateData.template;
                    bucketConfigurations = templateData.bucket_configurations || {};
                    updateOrchestrationPanel();
                    
                    // Clear current template selection
                    currentTemplateId = null;
                    isEditingTemplate = true;
                    document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
                    
                    showStatus(`Template "${templateData.name}" imported! Save to make permanent.`, 'success');
                    
                } catch (error) {
                    showStatus(`Import failed: ${error.message}`, 'error');
                }
            };
            input.click();
        }
        
        function shareTemplate() {
            if (!currentTemplateId) {
                showStatus('Please select a template first', 'error');
                return;
            }
            
            const currentPrompt = currentPrompts.find(p => p.id === currentTemplateId);
            if (!currentPrompt) return;
            
            // Create shareable data (without sensitive info)
            const shareData = {
                name: currentPrompt.name,
                description: currentPrompt.description,
                template: currentPrompt.template,
                bucket_configurations: bucketConfigurations
            };
            
            // Copy to clipboard
            const shareText = `Lizzy Template: ${currentPrompt.name}\n\n${JSON.stringify(shareData, null, 2)}`;
            navigator.clipboard.writeText(shareText).then(() => {
                showStatus('Template copied to clipboard for sharing', 'success');
            }).catch(() => {
                showStatus('Failed to copy to clipboard', 'error');
            });
        }
        
        function showTemplateAnalytics() {
            if (!currentTemplateId) {
                showStatus('Please select a template first', 'error');
                return;
            }
            
            const editor = document.getElementById('prompt-editor');
            const template = editor.value;
            
            // Analyze template
            const analysis = {
                totalLength: template.length,
                wordCount: template.split(/\s+/).length,
                basicVariables: (template.match(/\{[^}|]+\}/g) || []).length,
                enhancedVariables: (template.match(/\{[^}]+\|guidance:/g) || []).length,
                configuredBuckets: Object.keys(bucketConfigurations).length,
                sqlBlocks: (template.match(/\{sql\./g) || []).length,
                contextBlocks: (template.match(/\{context\./g) || []).length
            };
            
            const analyticsText = `
                Template Analytics:
                
                üìè Length: ${analysis.totalLength} characters
                üìù Words: ${analysis.wordCount}
                üîß Basic Variables: ${analysis.basicVariables}
                ‚ú® Enhanced Variables: ${analysis.enhancedVariables}
                ü™£ Configured Buckets: ${analysis.configuredBuckets}
                üóÑÔ∏è SQL Blocks: ${analysis.sqlBlocks}
                üéØ Context Blocks: ${analysis.contextBlocks}
                
                Enhancement Status: ${analysis.enhancedVariables > 0 ? 'Enhanced ‚úÖ' : 'Basic Template'}
            `;
            
            alert(analyticsText);
        }
        
        function insertBlock(blockKey) {
            const editor = document.getElementById('prompt-editor');
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            
            const variable = `{${blockKey}}`;
            editor.value = textBefore + variable + textAfter;
            editor.focus();
            editor.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
        }
        
        function showStatus(message, type = 'info') {
            // Simple status display - could be enhanced with a proper notification system
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Show temporary message near the data blocks
            const lightragContainer = document.getElementById('lightrag-blocks');
            if (lightragContainer) {
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = `
                    padding: 8px 12px; 
                    margin: 4px 0; 
                    border-radius: 4px; 
                    font-size: 0.9em;
                    background: ${type === 'error' ? '#fee' : type === 'success' ? '#efe' : '#eef'};
                    color: ${type === 'error' ? '#c53030' : type === 'success' ? '#38a169' : '#3182ce'};
                    border: 1px solid ${type === 'error' ? '#fc8181' : type === 'success' ? '#68d391' : '#90cdf4'};
                `;
                statusDiv.textContent = message;
                lightragContainer.insertBefore(statusDiv, lightragContainer.firstChild);
                
                // Remove after 3 seconds
                setTimeout(() => statusDiv.remove(), 3000);
            }
        }
        
        async function importAndUseBlock(block) {
            try {
                showStatus('Importing bucket...', 'info');
                
                // Import the bucket
                const importResponse = await fetch(`/api/library/import/${block.bucket}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!importResponse.ok) {
                    throw new Error(`Import failed: ${importResponse.statusText}`);
                }
                
                const importResult = await importResponse.json();
                
                if (importResult.success) {
                    showStatus('Bucket imported successfully! Refreshing data blocks...', 'success');
                    
                    // Refresh the data blocks to show the newly imported bucket
                    await loadProjectSchema();
                    
                    // Insert the block key (remove .available suffix)
                    const cleanKey = block.key.replace('.available', '');
                    insertBlock(cleanKey);
                    
                    showStatus('Bucket imported and added to prompt!', 'success');
                    return true; // Success
                } else {
                    throw new Error(importResult.error || 'Import failed');
                }
                
            } catch (error) {
                console.error('Import error:', error);
                showStatus(`Failed to import bucket: ${error.message}`, 'error');
                return false; // Failed
            }
        }

        async function loadProjectTemplates() {
            if (!currentProject) return;
            
            const container = document.getElementById('template-list');
            container.innerHTML = '<div class="loading">Loading templates...</div>';
            
            console.log('Loading templates for project:', currentProject);
            
            try {
                const response = await fetch(`/api/project/${currentProject}/prompts`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentPrompts = data.prompts || [];
                console.log('Loaded prompts:', currentPrompts);
                displayTemplates(currentPrompts);
                
                // Auto-select first template
                if (currentPrompts.length > 0) {
                    selectTemplate(currentPrompts[0].id);
                }
                
            } catch (error) {
                console.error('Error loading templates:', error);
                container.innerHTML = `<div class="error">Error loading templates: ${error.message}</div>`;
            }
        }
        
        function displayTemplates(prompts) {
            const container = document.getElementById('template-list');
            container.innerHTML = '';
            
            prompts.forEach(prompt => {
                const element = createTemplateElement(prompt);
                container.appendChild(element);
            });
        }
        
        function createTemplateElement(prompt) {
            const div = document.createElement('div');
            div.className = 'template-btn';
            div.onclick = () => selectTemplate(prompt.id);
            
            // Check if template has enhanced configurations
            const hasEnhanced = prompt.bucket_configurations && Object.keys(prompt.bucket_configurations).length > 0;
            const enhancedIcon = hasEnhanced ? ' ‚ú®' : '';
            const enhancedCount = hasEnhanced ? ` (${Object.keys(prompt.bucket_configurations).length} enhanced)` : '';
            
            div.innerHTML = `
                <div class="template-name">${prompt.name}${enhancedIcon}</div>
                <div class="template-desc">${prompt.description || 'No description'}${enhancedCount}</div>
                <div class="template-actions" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); editTemplate(${prompt.id})" style="font-size: 10px; padding: 4px 8px; margin-right: 4px;">‚úèÔ∏è</button>
                    ${hasEnhanced ? `<button class="btn btn-secondary" onclick="event.stopPropagation(); viewTemplateConfigs(${prompt.id})" style="font-size: 10px; padding: 4px 8px; margin-right: 4px; background: var(--accent); color: white;">ü™£</button>` : ''}
                    ${prompt.name !== 'System Brainstorm' ? `<button class="btn btn-secondary" onclick="event.stopPropagation(); deleteTemplate(${prompt.id})" style="font-size: 10px; padding: 4px 8px; background: var(--danger); color: white;">üóëÔ∏è</button>` : ''}
                </div>
            `;
            
            return div;
        }
        
        function viewTemplateConfigs(templateId) {
            const prompt = currentPrompts.find(p => p.id === templateId);
            if (!prompt || !prompt.bucket_configurations) return;
            
            const configs = prompt.bucket_configurations;
            const configText = Object.entries(configs)
                .map(([key, config]) => `‚Ä¢ ${config.label}: ${config.guidance} (${config.mode}, focus: ${config.focus}/10)`)
                .join('\n');
            
            alert(`Template: ${prompt.name}\n\nBucket Configurations:\n${configText}`);
        }
        
        function testEnhancedFeature() {
            // Simple test to see if enhanced features work
            const testBlock = {
                key: 'lightrag.test_bucket',
                label: 'Test Bucket',
                description: 'Testing the enhanced bucket guidance system'
            };
            
            console.log('Testing enhanced feature with block:', testBlock);
            showBucketGuidanceModal(testBlock);
        }
        
        function testBasicFunction() {
            alert('üéâ JavaScript is working! Current project: ' + (currentProject || 'None'));
            console.log('Basic test - currentProject:', currentProject);
            console.log('Basic test - currentMode:', currentMode);
        }

        function selectTemplate(templateId, element = null) {
            const prompt = currentPrompts.find(p => p.id === templateId);
            if (!prompt) return;
            
            currentTemplateId = templateId;
            isEditingTemplate = false;
            
            // Update active state
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            
            // Find the clicked element or the one with matching template ID
            if (element) {
                element.classList.add('active');
            } else {
                // Find by data attribute or content
                const templateElements = document.querySelectorAll('.template-btn');
                templateElements.forEach(btn => {
                    const nameEl = btn.querySelector('.template-name');
                    if (nameEl && nameEl.textContent === prompt.name) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Load template
            const editor = document.getElementById('prompt-editor');
            editor.value = prompt.template || '';
            
            // Load bucket configurations if available
            if (prompt.bucket_configurations) {
                bucketConfigurations = prompt.bucket_configurations;
                updateOrchestrationPanel();
                showStatus(`Loaded template "${prompt.name}" with ${Object.keys(bucketConfigurations).length} configured buckets`, 'success');
            } else {
                // Try to extract bucket configurations from existing template content
                bucketConfigurations = extractBucketConfigsFromTemplate(prompt.template || '');
                if (Object.keys(bucketConfigurations).length > 0) {
                    updateOrchestrationPanel();
                    showStatus(`Detected ${Object.keys(bucketConfigurations).length} enhanced variables in template "${prompt.name}"`, 'info');
                } else {
                    bucketConfigurations = {};
                    updateOrchestrationPanel();
                }
            }
        }
        
        function newTemplate() {
            const name = prompt('Template name:');
            if (!name) return;
            
            const description = prompt('Template description (optional):') || '';
            
            // Load with empty template
            const editor = document.getElementById('prompt-editor');
            editor.value = '';
            
            // Set editing mode
            isEditingTemplate = true;
            currentTemplateId = null;
            
            // Update UI to show we're creating new
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
        }
        
        function duplicateTemplate() {
            if (!currentTemplateId) {
                alert('Please select a template to duplicate');
                return;
            }
            
            const currentPrompt = currentPrompts.find(p => p.id === currentTemplateId);
            if (!currentPrompt) return;
            
            const name = prompt('Name for duplicated template:', currentPrompt.name + ' Copy');
            if (!name) return;
            
            const description = prompt('Description:', currentPrompt.description || '');
            
            // Load current template content
            const editor = document.getElementById('prompt-editor');
            editor.value = currentPrompt.template;
            
            // Set editing mode for new template
            isEditingTemplate = true;
            currentTemplateId = null;
            
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
        }
        
        function editTemplate(templateId) {
            const prompt = currentPrompts.find(p => p.id === templateId);
            if (!prompt) return;
            
            currentTemplateId = templateId;
            isEditingTemplate = true;
            
            // Load template for editing
            const editor = document.getElementById('prompt-editor');
            editor.value = prompt.template;
            
            // Update UI
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.template-btn').classList.add('active');
        }
        
        async function deleteTemplate(templateId) {
            const prompt = currentPrompts.find(p => p.id === templateId);
            if (!prompt) return;
            
            if (!confirm(`Delete template "${prompt.name}"?`)) return;
            
            try {
                const response = await fetch(`/api/project/${currentProject}/prompts/${templateId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Reload templates
                await loadProjectTemplates();
                
                alert('Template deleted successfully!');
                
            } catch (error) {
                alert(`Error deleting template: ${error.message}`);
            }
        }

        function clearEditor() {
            document.getElementById('prompt-editor').value = '';
        }

        async function previewPrompt() {
            const editor = document.getElementById('prompt-editor');
            const preview = document.getElementById('preview-area');
            const template = editor.value;
            
            if (!currentProject || !template.trim()) {
                preview.textContent = 'No project selected or template empty...';
                return;
            }
            
            preview.innerHTML = '<div class="loading"><span class="spinner"></span>Compiling with real project data...</div>';
            
            try {
                const response = await fetch('/api/compile-prompt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project_name: currentProject,
                        template: template
                    })
                });
                
                const data = await response.json();
                preview.textContent = data.compiled || 'Compilation failed';
                
            } catch (error) {
                preview.textContent = `Error compiling: ${error.message}`;
            }
        }

        async function saveCurrentPrompt() {
            const editor = document.getElementById('prompt-editor');
            const template = editor.value.trim();
            
            if (!template) {
                alert('Please enter a template to save');
                return;
            }
            
            if (!currentProject) {
                alert('Please select a project first');
                return;
            }
            
            let name, description;
            
            if (isEditingTemplate && currentTemplateId) {
                // Updating existing template
                const currentPrompt = currentPrompts.find(p => p.id === currentTemplateId);
                name = currentPrompt.name;
                description = currentPrompt.description;
                
                // Allow editing name/description
                const newName = prompt('Template name:', name);
                if (!newName) return;
                
                const newDescription = prompt('Template description:', description || '');
                
                try {
                    const response = await fetch(`/api/project/${currentProject}/prompts/${currentTemplateId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            name: newName,
                            template: template,
                            description: newDescription || '',
                            bucket_configurations: bucketConfigurations,
                            orchestration: {}
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    await loadProjectTemplates();
                    alert('Template updated successfully!');
                    
                } catch (error) {
                    alert(`Error updating template: ${error.message}`);
                }
                
            } else {
                // Creating new template
                name = prompt('Template name:');
                if (!name) return;
                
                description = prompt('Template description (optional):') || '';
                
                try {
                    const response = await fetch(`/api/project/${currentProject}/prompts`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            name: name,
                            template: template,
                            description: description,
                            bucket_configurations: bucketConfigurations,
                            orchestration: {}
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    await loadProjectTemplates();
                    alert(`Template "${name}" saved successfully!`);
                    
                } catch (error) {
                    alert(`Error saving template: ${error.message}`);
                }
            }
            
            isEditingTemplate = false;
        }

        function startBrainstorm() {
            const editor = document.getElementById('prompt-editor');
            if (!editor.value.trim() || !currentProject) {
                alert('Please select a project and create a prompt first!');
                return;
            }
            
            console.log('Starting brainstorm:', currentProject, editor.value);
            alert(`üöÄ Starting brainstorm session!\n\nProject: ${currentProject}\nData blocks: Real database content\nLightRAG: Active buckets\n\n(In production, this would launch the brainstorm interface)`);
        }

        function refreshProjects() {
            loadProjects();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            
            // Temperature slider update
            document.getElementById('temperature-slider').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
            });
            
            // Enter key support for chat
            document.getElementById('chat-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('bucket-guidance-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBucketModal();
                }
            });
            
            // Escape key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeBucketModal();
                }
            });
        });
    </script>
</body>
</html>